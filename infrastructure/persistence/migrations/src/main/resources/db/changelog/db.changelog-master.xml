<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="create_courier_statuses_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="courier_statuses"/>
            </not>
        </preConditions>

        <createTable tableName="courier_statuses">
            <column name="id" type="int">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_courier_status"/>
            </column>
            <column name="code" type="varchar(16)">
                <constraints unique="true" nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="insert_courier_statuses" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT count(*) FROM courier_statuses
            </sqlCheck>
        </preConditions>

        <insert tableName="courier_statuses">
            <column name="id" value="1"/>
            <column name="code" value="FREE"/>
        </insert>
        <insert tableName="courier_statuses">
            <column name="id" value="2"/>
            <column name="code" value="BUSY"/>
        </insert>
    </changeSet>

    <changeSet id="create_courier_transports_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="courier_transports"/>
            </not>
        </preConditions>

        <createTable tableName="courier_transports">
            <column name="id" type="int">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_courier_transports"/>
            </column>
            <column name="code" type="varchar(16)">
                <constraints unique="true" nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="insert_courier_transports" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT count(*) FROM courier_transports
            </sqlCheck>
        </preConditions>

        <insert tableName="courier_transports">
            <column name="id" value="1"/>
            <column name="code" value="PEDESTRIAN"/>
        </insert>
        <insert tableName="courier_transports">
            <column name="id" value="2"/>
            <column name="code" value="BICYCLE"/>
        </insert>
        <insert tableName="courier_transports">
            <column name="id" value="3"/>
            <column name="code" value="CAR"/>
        </insert>
        <insert tableName="courier_transports">
            <column name="id" value="4"/>
            <column name="code" value="DRONE"/>
        </insert>
    </changeSet>

    <changeSet id="create_couriers_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="couriers"/>
            </not>
        </preConditions>

        <createTable tableName="couriers">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_couriers"/>
            </column>
            <column name="name" type="varchar(30)">
                <constraints nullable="false"/>
            </column>
            <column name="location" type="varchar(64)">
                <constraints nullable="false"/>
            </column>
            <column name="status_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="transport_id" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex indexName="idx_courier_id" tableName="couriers">
            <column name="id"/>
        </createIndex>

        <addForeignKeyConstraint
                baseTableName="couriers"
                baseColumnNames="status_id"
                constraintName="fk_courier_status_id"
                referencedTableName="courier_statuses"
                referencedColumnNames="id"/>

        <addForeignKeyConstraint
                baseTableName="couriers"
                baseColumnNames="transport_id"
                constraintName="fk_couriers_transport_id"
                referencedTableName="courier_transports"
                referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="insert_couriers" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT count(*)
                FROM couriers
                WHERE id in (
                     '00000000-0000-0000-0000-000000000001',
                     '00000000-0000-0000-0000-000000000002',
                     '00000000-0000-0000-0000-000000000003'
                )
            </sqlCheck>
        </preConditions>

        <insert tableName="couriers">
            <column name="id" value="00000000-0000-0000-0000-000000000001"/>
            <column name="name" value="Вася Пешков"/>
            <column name="location" value="5,5"/>
            <column name="status_id" value="1"/>
            <column name="transport_id" value="1"/>
        </insert>

        <insert tableName="couriers">
            <column name="id" value="00000000-0000-0000-0000-000000000002"/>
            <column name="location" value="1,5"/>
            <column name="name" value="Петя Велосипедкин"/>
            <column name="status_id" value="1"/>
            <column name="transport_id" value="2"/>
        </insert>

        <insert tableName="couriers">
            <column name="id" value="00000000-0000-0000-0000-000000000003"/>
            <column name="name" value="Артур Машинин"/>
            <column name="location" value="9,9"/>
            <column name="status_id" value="1"/>
            <column name="transport_id" value="3"/>
        </insert>
    </changeSet>

    <changeSet id="create_order_statuses_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="order_statuses"/>
            </not>
        </preConditions>

        <createTable tableName="order_statuses">
            <column name="id" type="int">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_order_status"/>
            </column>
            <column name="code" type="varchar(16)">
                <constraints unique="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="insert_order_statuses" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT count(*) FROM order_statuses
            </sqlCheck>
        </preConditions>

        <insert tableName="order_statuses">
            <column name="id" value="1"/>
            <column name="code" value="CREATED"/>
        </insert>
        <insert tableName="order_statuses">
            <column name="id" value="2"/>
            <column name="code" value="ASSIGNED"/>
        </insert>
        <insert tableName="order_statuses">
            <column name="id" value="3"/>
            <column name="code" value="COMPLETED"/>
        </insert>
    </changeSet>

    <changeSet id="create_orders_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="orders"/>
            </not>
        </preConditions>

        <createTable tableName="orders">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_orders"/>
            </column>
            <column name="status_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="courier_id" type="uuid"/>
            <column name="location" type="varchar(64)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex indexName="idx_order_id" tableName="orders">
            <column name="id"/>
        </createIndex>

        <addForeignKeyConstraint
                baseTableName="orders"
                baseColumnNames="status_id"
                constraintName="fk_order_status_id"
                referencedTableName="order_statuses"
                referencedColumnNames="id"/>

        <addForeignKeyConstraint
                baseTableName="orders"
                baseColumnNames="courier_id"
                constraintName="fk_order_courier_id"
                referencedTableName="couriers"
                referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="create_message_statuses_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="message_statuses"/>
            </not>
        </preConditions>

        <createTable tableName="message_statuses">
            <column name="id" type="int">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_message_statuses"/>
            </column>
            <column name="code" type="varchar(32)">
                <constraints unique="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="insert_message_statuses" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT count(*) FROM message_statuses
            </sqlCheck>
        </preConditions>

        <insert tableName="message_statuses">
            <column name="id" value="1"/>
            <column name="code" value="TO_BE_PROCESSED"/>
        </insert>
        <insert tableName="message_statuses">
            <column name="id" value="2"/>
            <column name="code" value="SUCCESS"/>
        </insert>
        <insert tableName="message_statuses">
            <column name="id" value="3"/>
            <column name="code" value="CONVERSION_ERROR"/>
        </insert>
        <insert tableName="message_statuses">
            <column name="id" value="4"/>
            <column name="code" value="DELIVERY_ERROR"/>
        </insert>
    </changeSet>

    <changeSet id="create_inbox_messages_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="inbox_messages"/>
            </not>
        </preConditions>

        <createTable tableName="inbox_messages">
            <column name="event_id" type="uuid">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_inbox_messages"/>
            </column>
            <column name="event_type" type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="processed_at" type="timestamp">
                <constraints nullable="true"/>
            </column>
            <column name="version" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="status_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="error_description" type="text">
                <constraints nullable="true"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="inbox_messages"
                baseColumnNames="status_id"
                constraintName="fk_inbox_messages_status_id"
                referencedTableName="message_statuses"
                referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="create_outbox_messages_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="outbox_messages"/>
            </not>
        </preConditions>

        <createTable tableName="outbox_messages">
            <column name="event_id" type="uuid">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_outbox_messages"/>
            </column>
            <column name="event_type" type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="processed_at" type="timestamp">
                <constraints nullable="true"/>
            </column>
            <column name="version" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="status_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="error_description" type="text">
                <constraints nullable="true"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="outbox_messages"
                baseColumnNames="status_id"
                constraintName="fk_outbox_messages_status_id"
                referencedTableName="message_statuses"
                referencedColumnNames="id"/>
    </changeSet>

</databaseChangeLog>
