<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="create_courier_statuses_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="courier_statuses"/>
            </not>
        </preConditions>

        <createTable tableName="courier_statuses">
            <column name="id" type="int">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_courier_status"/>
            </column>
            <column name="code" type="varchar(16)">
                <constraints unique="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="insert_statuses_into_courier_status_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT count(*) FROM courier_statuses
            </sqlCheck>
        </preConditions>

        <insert tableName="courier_statuses">
            <column name="id" value="1"/>
            <column name="code" value="FREE"/>
        </insert>
        <insert tableName="courier_statuses">
            <column name="id" value="2"/>
            <column name="code" value="BUSY"/>
        </insert>
    </changeSet>

    <changeSet id="create_courier_transports_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="courier_transports"/>
            </not>
        </preConditions>

        <createTable tableName="courier_transports">
            <column name="id" type="int">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_courier_transports"/>
            </column>
            <column name="code" type="varchar(16)">
                <constraints unique="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="insert_transports_into_courier_transports_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT count(*) FROM courier_transports
            </sqlCheck>
        </preConditions>

        <insert tableName="courier_transports">
            <column name="id" value="1"/>
            <column name="code" value="PEDESTRIAN"/>
        </insert>
        <insert tableName="courier_transports">
            <column name="id" value="2"/>
            <column name="code" value="BICYCLE"/>
        </insert>
        <insert tableName="courier_transports">
            <column name="id" value="3"/>
            <column name="code" value="CAR"/>
        </insert>
        <insert tableName="courier_transports">
            <column name="id" value="4"/>
            <column name="code" value="DRONE"/>
        </insert>
    </changeSet>

    <changeSet id="create_courier_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="couriers"/>
            </not>
        </preConditions>

        <createTable tableName="couriers">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_couriers"/>
            </column>
            <column name="name" type="varchar(30)"/>
            <column name="location" type="varchar(64)"/>
            <column name="status_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="transport_id" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex indexName="idx_courier_id" tableName="couriers">
            <column name="id"/>
        </createIndex>

        <addForeignKeyConstraint
                baseTableName="couriers"
                baseColumnNames="status_id"
                constraintName="fk_courier_status_id"
                referencedTableName="courier_statuses"
                referencedColumnNames="id"/>

        <addForeignKeyConstraint
                baseTableName="couriers"
                baseColumnNames="transport_id"
                constraintName="fk_transport_id"
                referencedTableName="courier_transports"
                referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="module-4_infrastructure_postgres_adapter_7" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT count(*)
                FROM couriers
                WHERE id in (
                     '00000000-0000-0000-0000-000000000001',
                     '00000000-0000-0000-0000-000000000002',
                     '00000000-0000-0000-0000-000000000003'
                )
            </sqlCheck>
        </preConditions>

        <insert tableName="couriers">
            <column name="id" value="00000000-0000-0000-0000-000000000001"/>
            <column name="name" value="Вася Пешков"/>
            <column name="location" value="5,5"/>
            <column name="status_id" value="1"/>
            <column name="transport_id" value="1"/>
        </insert>

        <insert tableName="couriers">
            <column name="id" value="00000000-0000-0000-0000-000000000002"/>
            <column name="location" value="1,5"/>
            <column name="name" value="Петя Велосипедкин"/>
            <column name="status_id" value="1"/>
            <column name="transport_id" value="2"/>
        </insert>

        <insert tableName="couriers">
            <column name="id" value="00000000-0000-0000-0000-000000000003"/>
            <column name="name" value="Артур Машинин"/>
            <column name="location" value="9,9"/>
            <column name="status_id" value="1"/>
            <column name="transport_id" value="3"/>
        </insert>
    </changeSet>

    <changeSet id="create_order_statuses_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="order_statuses"/>
            </not>
        </preConditions>

        <createTable tableName="order_statuses">
            <column name="id" type="int">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_order_status"/>
            </column>
            <column name="code" type="varchar(16)">
                <constraints unique="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="insert_statuses_into_order_statuses_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT count(*) FROM order_statuses
            </sqlCheck>
        </preConditions>

        <insert tableName="order_statuses">
            <column name="id" value="1"/>
            <column name="code" value="CREATED"/>
        </insert>
        <insert tableName="order_statuses">
            <column name="id" value="2"/>
            <column name="code" value="ASSIGNED"/>
        </insert>
        <insert tableName="order_statuses">
            <column name="id" value="3"/>
            <column name="code" value="COMPLETED"/>
        </insert>
    </changeSet>

    <changeSet id="create_couriers_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="orders"/>
            </not>
        </preConditions>

        <createTable tableName="orders">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_orders"/>
            </column>
            <column name="status_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="courier_id" type="uuid"/>
            <column name="location" type="varchar(64)"/>
        </createTable>

        <createIndex indexName="idx_order_id" tableName="orders">
            <column name="id"/>
        </createIndex>

        <addForeignKeyConstraint
                baseTableName="orders"
                baseColumnNames="status_id"
                constraintName="fk_order_status_id"
                referencedTableName="order_statuses"
                referencedColumnNames="id"/>

        <addForeignKeyConstraint
                baseTableName="orders"
                baseColumnNames="courier_id"
                constraintName="fk_order_courier_id"
                referencedTableName="couriers"
                referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="create_in_out_box_status_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="in_out_box_status"/>
            </not>
        </preConditions>

        <createTable tableName="in_out_box_status">
            <column name="id" type="int">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_in_out_box_status"/>
            </column>
            <column name="code" type="varchar(32)">
                <constraints unique="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="insert_statuses_into_in_out_box_status_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT count(*) FROM in_out_box_status
            </sqlCheck>
        </preConditions>

        <insert tableName="in_out_box_status">
            <column name="id" value="1"/>
            <column name="code" value="TO_BE_PROCESSED"/>
        </insert>
        <insert tableName="in_out_box_status">
            <column name="id" value="2"/>
            <column name="code" value="SUCCESSFULLY"/>
        </insert>
        <insert tableName="in_out_box_status">
            <column name="id" value="3"/>
            <column name="code" value="CONVERSION_ERROR"/>
        </insert>
        <insert tableName="in_out_box_status">
            <column name="id" value="4"/>
            <column name="code" value="DELIVERY_ERROR"/>
        </insert>
    </changeSet>

    <changeSet id="create_out_box_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="out_box"/>
            </not>
        </preConditions>

        <createTable tableName="out_box">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_out_box"/>
            </column>
            <column name="event_type" type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="processed_at" type="timestamp">
                <constraints nullable="true"/>
            </column>
            <column name="version" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="status_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="error_description" type="text">
                <constraints nullable="true"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="out_box"
                baseColumnNames="status_id"
                constraintName="fk_out_box_status_id"
                referencedTableName="in_out_box_status"
                referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="create_in_box_table" author="Nikita Koshelev">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="in_box"/>
            </not>
        </preConditions>

        <createTable tableName="in_box">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_in_box"/>
            </column>
            <column name="event_type" type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="processed_at" type="timestamp">
                <constraints nullable="true"/>
            </column>
            <column name="version" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="status_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="error_description" type="text">
                <constraints nullable="true"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="in_box"
                baseColumnNames="status_id"
                constraintName="fk_in_box_status_id"
                referencedTableName="in_out_box_status"
                referencedColumnNames="id"/>
    </changeSet>

</databaseChangeLog>
